<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microsoft Entra ID Branding Configurator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="app" class="min-h-screen bg-gray-900">
        <!-- Header -->
        <div class="bg-gray-800 shadow-lg border-b border-gray-700">
            <div class="max-w-7xl mx-auto px-8 py-6">
                <h1 class="text-3xl font-bold text-gray-100 mb-3">Microsoft Entra ID Branding Configurator</h1>
                <div class="text-gray-300 space-y-2">
                    <p class="text-lg">üé® <strong>Generate Microsoft 365 branding assets</strong> that meet all official size and dimension requirements</p>
                    <div class="grid grid-cols-2 gap-4 mt-4 text-sm">
                        <div class="flex items-start">
                            <span class="text-green-400 mr-2">‚úì</span>
                            <span>Creates optimized images following <a href="https://learn.microsoft.com/en-us/entra/fundamentals/how-to-customize-branding" target="_blank" class="text-blue-400 underline hover:text-blue-300">Microsoft's specifications</a></span>
                        </div>
                        <div class="flex items-start">
                            <span class="text-green-400 mr-2">‚úì</span>
                            <span>Includes ready-to-run PowerShell script for easy deployment</span>
                        </div>
                    </div>
                    
                    <!-- Security Notice -->
                    <div class="mt-4 p-4 bg-green-900/20 border border-green-700/50 rounded-lg">
                        <h4 class="font-semibold text-green-400 mb-2 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            100% Secure & Private
                        </h4>
                        <ul class="text-sm text-gray-300 space-y-1 ml-7">
                            <li>‚Ä¢ No company data is collected or transmitted</li>
                            <li>‚Ä¢ All processing happens locally in your browser</li>
                            <li>‚Ä¢ The PowerShell script connects directly to Microsoft Graph</li>
                            <li>‚Ä¢ Your logo and branding choices never leave your device</li>
                        </ul>
                    </div>
                    
                    <!-- Technical Details -->
                    <details class="mt-4 bg-gray-800 border border-gray-700 rounded-lg p-4">
                        <summary class="cursor-pointer font-semibold text-gray-200 hover:text-gray-100">üìã Technical Details (click to expand)</summary>
                        <div class="mt-3 space-y-3 text-sm text-gray-300">
                            <div>
                                <strong>How it works:</strong>
                                <ul class="ml-6 mt-1 list-disc space-y-1">
                                    <li>Generates all required branding assets using HTML5 Canvas API</li>
                                    <li>Optimizes file sizes to meet Microsoft's strict limits (PNG: 50KB, JPEG: 300KB)</li>
                                    <li>Creates separate light and dark theme variants</li>
                                    <li>Packages everything with a PowerShell deployment script</li>
                                </ul>
                            </div>
                            <div>
                                <strong>Generated Assets:</strong>
                                <ul class="ml-6 mt-1 list-disc space-y-1">
                                    <li><strong>Banner Logo (280√ó60px):</strong> Used in email footers and some app headers</li>
                                    <li><strong>Header Logo (245√ó36px):</strong> Displayed in app headers and navigation</li>
                                    <li><strong>Square Logos (240√ó240px):</strong> Light/dark variants for app tiles</li>
                                    <li><strong>Favicon (32√ó32px):</strong> Browser tab icon</li>
                                    <li><strong>Backgrounds (1920√ó1080px):</strong> Sign-in page backgrounds for both themes</li>
                                </ul>
                            </div>
                            <div>
                                <strong>PowerShell Script Features:</strong>
                                <ul class="ml-6 mt-1 list-disc space-y-1">
                                    <li>Uses Microsoft Graph PowerShell SDK</li>
                                    <li>Validates file sizes before upload</li>
                                    <li>Configures both default (light) and en-US (dark) localizations</li>
                                    <li>Handles errors gracefully with retry guidance</li>
                                </ul>
                            </div>
                        </div>
                    </details>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-8 py-8">
            <!-- Main Content -->
            <div class="grid grid-cols-2 gap-8">
                <!-- Configuration Panel -->
                <div class="bg-gray-800 rounded-lg shadow-xl p-6 border border-gray-700">
                    <h2 class="text-xl font-semibold mb-6 text-gray-100">Branding Configuration</h2>
                    
                    <!-- Primary Color -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Primary Brand Color
                        </label>
                        <div class="flex items-center space-x-4">
                            <input type="color" id="primaryColor" value="#0078D4" class="h-12 w-24 rounded cursor-pointer">
                            <input type="text" id="primaryColorText" value="#0078D4" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-md font-mono">
                        </div>
                    </div>
                    
                    <!-- Secondary Color -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Secondary Color
                        </label>
                        <div class="flex items-center space-x-4">
                            <input type="color" id="secondaryColor" value="#106EBE" class="h-12 w-24 rounded cursor-pointer">
                            <input type="text" id="secondaryColorText" value="#106EBE" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-md font-mono">
                        </div>
                    </div>
                    
                    <!-- Logo Upload -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Company Logo (PNG with transparent background)
                        </label>
                        <input type="file" id="logoInput" accept="image/*" class="hidden">
                        <button id="uploadBtn" class="w-full px-4 py-3 border-2 border-dashed border-gray-600 rounded-lg hover:border-gray-500 transition-colors">
                            <span id="uploadText" class="text-gray-400">Click to upload logo</span>
                            <div id="logoPreview" class="hidden flex items-center justify-center">
                                <img id="logoImg" class="h-16 mr-4">
                                <span class="text-green-400">‚úì Logo uploaded</span>
                            </div>
                        </button>
                    </div>
                    
                    <!-- Generate Button -->
                    <button id="generateBtn" disabled class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed transition-colors font-semibold">
                        <span id="generateText">Generate Branding Package</span>
                        <div id="generateSpinner" class="hidden">
                            <div class="spinner"></div>
                            Generating Assets...
                        </div>
                    </button>
                    
                    <!-- Info Box -->
                    <div class="mt-6 p-4 bg-blue-900/30 border border-blue-700/50 rounded-lg">
                        <h3 class="font-semibold text-sm text-blue-300 mb-2">Image Requirements (Microsoft Specs):</h3>
                        <ul class="text-xs text-blue-200 space-y-1">
                            <li>‚Ä¢ <strong>Sign-in background:</strong> 1920√ó1080px, JPEG, max 300KB</li>
                            <li>‚Ä¢ <strong>Banner logo:</strong> 280√ó60px, PNG, max 50KB</li>
                            <li>‚Ä¢ <strong>Header logo:</strong> 245√ó36px, PNG, max 10KB</li>
                            <li>‚Ä¢ <strong>Square logos:</strong> 240√ó240px, PNG, max 50KB</li>
                            <li>‚Ä¢ <strong>Favicon:</strong> 32√ó32px, PNG, max 5KB</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Preview Panel -->
                <div class="bg-gray-800 rounded-lg shadow-xl p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-100">Preview</h2>
                        <button id="darkModeBtn" class="px-3 py-1 rounded-lg bg-gray-700 hover:bg-gray-600 text-sm font-medium text-gray-100">
                            <span id="darkModeText">Light Theme</span>
                        </button>
                    </div>
                    
                    <div id="previewArea" class="bg-gray-700 rounded-lg p-4 min-h-[500px] flex items-center justify-center">
                        <div class="text-center text-gray-400">
                            <p>Upload your logo and generate assets to see preview</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div id="resultsSection" class="hidden mt-8">
                <div class="bg-gray-800 rounded-lg shadow-xl p-8 text-center border border-gray-700">
                    <h2 class="text-2xl font-bold text-gray-100 mb-4">‚úÖ Your Branding Package is Ready!</h2>
                    <p class="text-gray-300 mb-6">Download the ZIP file containing all images and deployment script</p>
                    
                    <div class="grid grid-cols-3 gap-4 mb-8 max-w-3xl mx-auto">
                        <div class="bg-green-900/30 border border-green-700/50 p-4 rounded-lg">
                            <h3 class="font-semibold text-green-400">7 Images</h3>
                            <p class="text-sm text-green-300">All branding assets</p>
                        </div>
                        <div class="bg-blue-900/30 border border-blue-700/50 p-4 rounded-lg">
                            <h3 class="font-semibold text-blue-400">PowerShell Script</h3>
                            <p class="text-sm text-blue-300">Deploys everything</p>
                        </div>
                        <div class="bg-purple-900/30 border border-purple-700/50 p-4 rounded-lg">
                            <h3 class="font-semibold text-purple-400">Auto-Deploy</h3>
                            <p class="text-sm text-purple-300">Run script & done!</p>
                        </div>
                    </div>
                    
                    <button id="downloadBtn" class="px-8 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold text-lg">
                        ‚¨áÔ∏è Download Branding Package
                    </button>
                    
                    <div class="mt-8 text-left max-w-2xl mx-auto">
                        <h3 class="font-semibold mb-3 text-gray-100">Quick Deployment Steps:</h3>
                        <ol class="text-sm text-gray-300 space-y-2">
                            <li>1. Extract the ZIP file to a folder</li>
                            <li>2. Open PowerShell as Administrator</li>
                            <li>3. Navigate to the extracted folder</li>
                            <li>4. Run: <code class="bg-gray-700 px-2 py-1 rounded text-gray-100">.\Deploy-M365Branding.ps1</code></li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="mt-16 py-8 text-center text-gray-400">
            <p class="text-sm">
                Created by <a href="https://github.com/junior6995/" target="_blank" class="text-blue-400 hover:text-blue-300 font-semibold">@junior6995</a>
            </p>
        </footer>
    </div>
    
    <!-- Hidden Canvas -->
    <canvas id="canvas" style="display: none;"></canvas>
    
    <script>
        // Global variables
        let logo = null;
        let logoDataUrl = null;
        let darkMode = false;
        let generatedAssets = {};
        
        // Get elements
        const primaryColorInput = document.getElementById('primaryColor');
        const primaryColorText = document.getElementById('primaryColorText');
        const secondaryColorInput = document.getElementById('secondaryColor');
        const secondaryColorText = document.getElementById('secondaryColorText');
        const logoInput = document.getElementById('logoInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadText = document.getElementById('uploadText');
        const logoPreview = document.getElementById('logoPreview');
        const logoImg = document.getElementById('logoImg');
        const generateBtn = document.getElementById('generateBtn');
        const generateText = document.getElementById('generateText');
        const generateSpinner = document.getElementById('generateSpinner');
        const darkModeBtn = document.getElementById('darkModeBtn');
        const darkModeText = document.getElementById('darkModeText');
        const previewArea = document.getElementById('previewArea');
        const resultsSection = document.getElementById('resultsSection');
        const downloadBtn = document.getElementById('downloadBtn');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // Set high quality rendering
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        
        // Color sync
        primaryColorInput.addEventListener('change', (e) => {
            primaryColorText.value = e.target.value;
        });
        primaryColorText.addEventListener('change', (e) => {
            if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                primaryColorInput.value = e.target.value;
            }
        });
        secondaryColorInput.addEventListener('change', (e) => {
            secondaryColorText.value = e.target.value;
        });
        secondaryColorText.addEventListener('change', (e) => {
            if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                secondaryColorInput.value = e.target.value;
            }
        });
        
        // Logo upload
        uploadBtn.addEventListener('click', () => {
            logoInput.click();
        });
        
        logoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        logo = img;
                        logoDataUrl = event.target.result;
                        logoImg.src = logoDataUrl;
                        uploadText.classList.add('hidden');
                        logoPreview.classList.remove('hidden');
                        generateBtn.disabled = false;
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Dark mode toggle
        darkModeBtn.addEventListener('click', () => {
            darkMode = !darkMode;
            darkModeText.textContent = darkMode ? 'Dark Theme' : 'Light Theme';
            updatePreview();
        });
        
        // Generate assets
        generateBtn.addEventListener('click', generateAssets);
        
        // Generate banner logo (280x60) - Max 50KB with transparent logo
        function generateBannerLogo() {
            canvas.width = 280;
            canvas.height = 60;
            
            ctx.clearRect(0, 0, 280, 60);
            
            // Dynamic gradient background
            const gradient = ctx.createLinearGradient(0, 0, 280, 0);
            gradient.addColorStop(0, adjustColor(primaryColorInput.value, 20));
            gradient.addColorStop(0.3, primaryColorInput.value);
            gradient.addColorStop(0.7, secondaryColorInput.value);
            gradient.addColorStop(1, adjustColor(secondaryColorInput.value, -20));
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 280, 60);
            
            // Sophisticated overlay pattern
            ctx.globalAlpha = 0.15;
            
            // Wave pattern
            ctx.beginPath();
            ctx.moveTo(0, 30);
            for (let i = 0; i <= 280; i += 5) {
                ctx.lineTo(i, 30 + Math.sin(i * 0.02) * 20);
            }
            ctx.lineTo(280, 60);
            ctx.lineTo(0, 60);
            ctx.closePath();
            const waveGradient = ctx.createLinearGradient(0, 0, 0, 60);
            waveGradient.addColorStop(0, 'rgba(255, 255, 255, 0.3)');
            waveGradient.addColorStop(1, 'rgba(0, 0, 0, 0.1)');
            ctx.fillStyle = waveGradient;
            ctx.fill();
            
            // Geometric accents
            ctx.globalAlpha = 0.1;
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 1;
            for (let i = 0; i < 280; i += 40) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i + 20, 60);
                ctx.stroke();
            }
            
            ctx.globalAlpha = 1;
            
            if (logo) {
                // Center the logo with optimal sizing
                const logoAspect = logo.width / logo.height;
                let drawWidth, drawHeight;
                const maxHeight = 50;
                const maxWidth = 200;
                
                if (logoAspect > maxWidth/maxHeight) {
                    drawWidth = maxWidth;
                    drawHeight = drawWidth / logoAspect;
                } else {
                    drawHeight = maxHeight;
                    drawWidth = drawHeight * logoAspect;
                }
                
                const x = (280 - drawWidth) / 2;
                const y = (60 - drawHeight) / 2;
                
                // Ensure high quality rendering
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                // Draw logo with transparency preserved
                ctx.drawImage(logo, x, y, drawWidth, drawHeight);
            } else {
                // Fallback: show initial
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 32px -apple-system, BlinkMacSystemFont, "Segoe UI", Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.shadowColor = 'rgba(0,0,0,0.3)';
                ctx.shadowBlur = 4;
                ctx.fillText('C', 140, 30);
            }
            
            // Return with quality optimized for 50KB
            return canvas.toDataURL('image/png', 0.92);
        }
        
        // Generate header logo (245x36) - Max 10KB with creative design
        function generateHeaderLogo() {
            canvas.width = 245;
            canvas.height = 36;
            
            // Clear with transparency
            ctx.clearRect(0, 0, 245, 36);
            
            if (logo) {
                // Creative gradient background strip
                const bgGradient = ctx.createLinearGradient(0, 0, 245, 0);
                bgGradient.addColorStop(0, primaryColorInput.value + '15');
                bgGradient.addColorStop(0.5, secondaryColorInput.value + '10');
                bgGradient.addColorStop(1, primaryColorInput.value + '15');
                ctx.fillStyle = bgGradient;
                ctx.fillRect(0, 0, 245, 36);
                
                // Accent line at bottom
                const accentGradient = ctx.createLinearGradient(0, 0, 245, 0);
                accentGradient.addColorStop(0, primaryColorInput.value);
                accentGradient.addColorStop(0.5, secondaryColorInput.value);
                accentGradient.addColorStop(1, primaryColorInput.value);
                ctx.fillStyle = accentGradient;
                ctx.fillRect(0, 34, 245, 2);
                
                // Logo positioning - left side
                const logoAspect = logo.width / logo.height;
                let drawWidth, drawHeight;
                const maxHeight = 28;
                const maxWidth = 80;
                
                if (logoAspect > maxWidth/maxHeight) {
                    drawWidth = maxWidth;
                    drawHeight = drawWidth / logoAspect;
                } else {
                    drawHeight = maxHeight;
                    drawWidth = drawHeight * logoAspect;
                }
                
                const x = 8;
                const y = (36 - drawHeight) / 2;
                
                // Subtle white backing for logo visibility
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.fillRect(x - 2, y - 2, drawWidth + 4, drawHeight + 4);
                
                // Ensure high quality rendering
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                ctx.drawImage(logo, x, y, drawWidth, drawHeight);
                
                // Creative geometric element on right
                ctx.globalAlpha = 0.3;
                ctx.fillStyle = secondaryColorInput.value;
                ctx.beginPath();
                ctx.moveTo(245, 0);
                ctx.lineTo(200, 0);
                ctx.lineTo(245, 36);
                ctx.closePath();
                ctx.fill();
                ctx.globalAlpha = 1;
                
            } else {
                // Fallback design
                const gradient = ctx.createLinearGradient(0, 0, 245, 0);
                gradient.addColorStop(0, primaryColorInput.value);
                gradient.addColorStop(1, secondaryColorInput.value);
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 245, 36);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText('Your Company', 10, 18);
            }
            
            // Return with balanced compression for 10KB limit
            return canvas.toDataURL('image/png', 0.65);
        }
        
        // Generate favicon (32x32) - Max 5KB
        function generateFavicon() {
            canvas.width = 32;
            canvas.height = 32;
            
            ctx.clearRect(0, 0, 32, 32);
            
            if (logo) {
                // White background for visibility
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, 32, 32);
                
                // Add subtle brand accent
                const accentGradient = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
                accentGradient.addColorStop(0, primaryColorInput.value + '10');
                accentGradient.addColorStop(1, secondaryColorInput.value + '10');
                ctx.fillStyle = accentGradient;
                ctx.fillRect(0, 0, 32, 32);
                
                const logoAspect = logo.width / logo.height;
                let drawWidth, drawHeight;
                const maxSize = 28;
                
                if (logoAspect > 1) {
                    drawWidth = maxSize;
                    drawHeight = maxSize / logoAspect;
                } else {
                    drawHeight = maxSize;
                    drawWidth = maxSize * logoAspect;
                }
                
                const x = (32 - drawWidth) / 2;
                const y = (32 - drawHeight) / 2;
                
                // Enable image smoothing for better quality at small size
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                ctx.drawImage(logo, x, y, drawWidth, drawHeight);
            } else {
                // Gradient background with initial
                const gradient = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
                gradient.addColorStop(0, primaryColorInput.value);
                gradient.addColorStop(1, secondaryColorInput.value);
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 32, 32);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 20px -apple-system, BlinkMacSystemFont, "Segoe UI", Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('C', 16, 16);
            }
            
            // Return with moderate compression to stay under 5KB
            return canvas.toDataURL('image/png', 0.8);
        }
        
        // Generate square logo (240x240) - Max 50KB simple design
        function generateSquareLogo(theme) {
            canvas.width = 240;
            canvas.height = 240;
            
            // Clear with transparency
            ctx.clearRect(0, 0, 240, 240);
            
            if (logo) {
                // Simple solid background
                if (theme === 'light') {
                    ctx.fillStyle = '#ffffff';
                } else {
                    ctx.fillStyle = '#1a1a1a';
                }
                ctx.fillRect(0, 0, 240, 240);
                
                // Draw logo centered
                const logoAspect = logo.width / logo.height;
                let drawWidth, drawHeight;
                const maxSize = 200;
                
                if (logoAspect > 1) {
                    drawWidth = maxSize;
                    drawHeight = maxSize / logoAspect;
                } else {
                    drawHeight = maxSize;
                    drawWidth = maxSize * logoAspect;
                }
                
                const x = (240 - drawWidth) / 2;
                const y = (240 - drawHeight) / 2;
                
                // Simple shadow for depth
                if (theme === 'light') {
                    ctx.shadowColor = 'rgba(0,0,0,0.15)';
                    ctx.shadowBlur = 10;
                    ctx.shadowOffsetY = 3;
                } else {
                    ctx.shadowColor = 'rgba(0,0,0,0.5)';
                    ctx.shadowBlur = 15;
                    ctx.shadowOffsetY = 5;
                }
                
                // Ensure high quality rendering
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                ctx.drawImage(logo, x, y, drawWidth, drawHeight);
                ctx.shadowColor = 'transparent';
                
            } else {
                // No logo - simple gradient square
                const gradient = ctx.createLinearGradient(0, 0, 240, 240);
                if (theme === 'light') {
                    gradient.addColorStop(0, primaryColorInput.value);
                    gradient.addColorStop(1, secondaryColorInput.value);
                } else {
                    gradient.addColorStop(0, adjustColor(primaryColorInput.value, -60));
                    gradient.addColorStop(1, adjustColor(secondaryColorInput.value, -60));
                }
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 240, 240);
                
                // Company initial
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 96px -apple-system, BlinkMacSystemFont, "Segoe UI", Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('C', 120, 120);
            }
            
            // Return with quality optimized for 50KB limit
            return canvas.toDataURL('image/png', 0.95);
        }
        
        // Generate sign-in background (1920x1080) - Max 300KB with distinct themes
        function generateSignInBackground(theme) {
            canvas.width = 1920;
            canvas.height = 1080;
            
            ctx.clearRect(0, 0, 1920, 1080);
            
            if (theme === 'light') {
                // Light theme: Bright and airy
                // Base: White to light brand colors
                const baseGradient = ctx.createLinearGradient(0, 0, 1920, 1080);
                baseGradient.addColorStop(0, '#ffffff');
                baseGradient.addColorStop(0.3, '#f8f9fa');
                baseGradient.addColorStop(0.7, adjustColor(primaryColorInput.value, 170));
                baseGradient.addColorStop(1, adjustColor(primaryColorInput.value, 150));
                ctx.fillStyle = baseGradient;
                ctx.fillRect(0, 0, 1920, 1080);
                
                // Soft color washes
                ctx.globalAlpha = 0.2;
                const wash1 = ctx.createRadialGradient(500, 300, 0, 500, 300, 600);
                wash1.addColorStop(0, primaryColorInput.value);
                wash1.addColorStop(1, 'transparent');
                ctx.fillStyle = wash1;
                ctx.fillRect(0, 0, 1920, 1080);
                
                const wash2 = ctx.createRadialGradient(1400, 700, 0, 1400, 700, 500);
                wash2.addColorStop(0, secondaryColorInput.value);
                wash2.addColorStop(1, 'transparent');
                ctx.fillStyle = wash2;
                ctx.fillRect(0, 0, 1920, 1080);
                
                // Abstract shapes
                ctx.globalAlpha = 0.1;
                ctx.fillStyle = primaryColorInput.value;
                ctx.beginPath();
                ctx.arc(1700, 200, 300, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(200, 900, 400, 0, Math.PI * 2);
                ctx.fill();
                
                // Flowing wave
                ctx.globalAlpha = 0.15;
                ctx.beginPath();
                ctx.moveTo(0, 800);
                for (let i = 0; i <= 1920; i += 20) {
                    ctx.lineTo(i, 800 + Math.sin(i * 0.005) * 100);
                }
                ctx.lineTo(1920, 1080);
                ctx.lineTo(0, 1080);
                ctx.closePath();
                ctx.fillStyle = adjustColor(secondaryColorInput.value, 120);
                ctx.fill();
                
            } else {
                // Dark theme: Deep and sophisticated
                // Base: Dark gradient
                const baseGradient = ctx.createLinearGradient(0, 0, 1920, 1080);
                baseGradient.addColorStop(0, '#0a0a0a');
                baseGradient.addColorStop(0.3, '#121212');
                baseGradient.addColorStop(0.7, adjustColor(primaryColorInput.value, -120));
                baseGradient.addColorStop(1, adjustColor(primaryColorInput.value, -100));
                ctx.fillStyle = baseGradient;
                ctx.fillRect(0, 0, 1920, 1080);
                
                // Color accents with glow
                ctx.globalAlpha = 0.3;
                
                // Neon-like glow effect
                const glow1 = ctx.createRadialGradient(300, 300, 0, 300, 300, 500);
                glow1.addColorStop(0, primaryColorInput.value);
                glow1.addColorStop(0.5, adjustColor(primaryColorInput.value, -40));
                glow1.addColorStop(1, 'transparent');
                ctx.fillStyle = glow1;
                ctx.fillRect(0, 0, 1920, 1080);
                
                const glow2 = ctx.createRadialGradient(1600, 800, 0, 1600, 800, 600);
                glow2.addColorStop(0, secondaryColorInput.value);
                glow2.addColorStop(0.5, adjustColor(secondaryColorInput.value, -40));
                glow2.addColorStop(1, 'transparent');
                ctx.fillStyle = glow2;
                ctx.fillRect(0, 0, 1920, 1080);
                
                // Grid pattern
                ctx.globalAlpha = 0.05;
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 1;
                for (let x = 0; x < 1920; x += 80) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, 1080);
                    ctx.stroke();
                }
                for (let y = 0; y < 1080; y += 80) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(1920, y);
                    ctx.stroke();
                }
                
                // Gradient mesh overlay
                ctx.globalAlpha = 0.15;
                const meshGradient = ctx.createLinearGradient(0, 0, 1920, 0);
                meshGradient.addColorStop(0, 'transparent');
                meshGradient.addColorStop(0.5, primaryColorInput.value);
                meshGradient.addColorStop(1, 'transparent');
                ctx.fillStyle = meshGradient;
                ctx.fillRect(0, 400, 1920, 280);
            }
            
            // Set high quality rendering for the entire process
            ctx.save();
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            ctx.globalAlpha = 1;
            
            // Return as JPEG with maximum quality within 300KB limit
            const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
            ctx.restore();
            return dataUrl;
        }
        
        function adjustColor(hex, amount) {
            const num = parseInt(hex.replace('#', ''), 16);
            const r = Math.max(0, Math.min(255, ((num >> 16) & 255) + amount));
            const g = Math.max(0, Math.min(255, ((num >> 8) & 255) + amount));
            const b = Math.max(0, Math.min(255, (num & 255) + amount));
            return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
        }
        
        function generateAssets() {
            generateText.classList.add('hidden');
            generateSpinner.classList.remove('hidden');
            generateBtn.disabled = true;
            
            setTimeout(() => {
                generatedAssets = {
                    bannerLogo: generateBannerLogo(),
                    headerLogo: generateHeaderLogo(),
                    favicon: generateFavicon(),
                    squareLogoLight: generateSquareLogo('light'),
                    squareLogoDark: generateSquareLogo('dark'),
                    signInBgLight: generateSignInBackground('light'),
                    signInBgDark: generateSignInBackground('dark'),
                    script: generatePowerShellScript()
                };
                
                generateText.classList.remove('hidden');
                generateSpinner.classList.add('hidden');
                generateBtn.disabled = false;
                
                updatePreview();
                showResults();
            }, 1500);
        }
        
        function generatePowerShellScript() {
            return `# Microsoft Entra ID Branding Deployment Script
# Generated: ${new Date().toLocaleString()}
# Primary Color: ${primaryColorInput.value}

Write-Host "Microsoft Entra ID Branding Deployment" -ForegroundColor Cyan
Write-Host "======================================" -ForegroundColor Cyan

# Check files
$requiredFiles = @(
    "BannerLogo.png",
    "HeaderLogo.png",
    "Favicon.png",
    "SquareLogoLight.png",
    "SquareLogoDark.png",
    "BackgroundLight.jpg",
    "BackgroundDark.jpg"
)

$scriptPath = $PSScriptRoot
$missingFiles = @()

foreach ($file in $requiredFiles) {
    if (-not (Test-Path (Join-Path $scriptPath $file))) {
        $missingFiles += $file
    }
}

if ($missingFiles.Count -gt 0) {
    Write-Host "Missing files:" -ForegroundColor Red
    $missingFiles | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
    exit 1
}

Write-Host "All files found!" -ForegroundColor Green

# Validate file sizes
Write-Host "Validating file sizes..." -ForegroundColor Yellow
$bannerSize = (Get-Item (Join-Path $scriptPath "BannerLogo.png")).Length / 1KB
$headerSize = (Get-Item (Join-Path $scriptPath "HeaderLogo.png")).Length / 1KB
$faviconSize = (Get-Item (Join-Path $scriptPath "Favicon.png")).Length / 1KB
$squareLightSize = (Get-Item (Join-Path $scriptPath "SquareLogoLight.png")).Length / 1KB
$squareDarkSize = (Get-Item (Join-Path $scriptPath "SquareLogoDark.png")).Length / 1KB

Write-Host "  BannerLogo.png: $([math]::Round($bannerSize, 2)) KB (limit: 50 KB)" -ForegroundColor $(if ($bannerSize -lt 50) { "Green" } else { "Red" })
Write-Host "  HeaderLogo.png: $([math]::Round($headerSize, 2)) KB (limit: 10 KB)" -ForegroundColor $(if ($headerSize -lt 10) { "Green" } else { "Red" })
Write-Host "  Favicon.png: $([math]::Round($faviconSize, 2)) KB (limit: 5 KB)" -ForegroundColor $(if ($faviconSize -lt 5) { "Green" } else { "Red" })
Write-Host "  SquareLogoLight.png: $([math]::Round($squareLightSize, 2)) KB (limit: 50 KB)" -ForegroundColor $(if ($squareLightSize -lt 50) { "Green" } else { "Red" })
Write-Host "  SquareLogoDark.png: $([math]::Round($squareDarkSize, 2)) KB (limit: 50 KB)" -ForegroundColor $(if ($squareDarkSize -lt 50) { "Green" } else { "Red" })

if ($bannerSize -gt 50 -or $headerSize -gt 10 -or $faviconSize -gt 5 -or $squareLightSize -gt 50 -or $squareDarkSize -gt 50) {
    Write-Host "ERROR: One or more files exceed their size limits!" -ForegroundColor Red
    Write-Host "Please regenerate the assets with a smaller logo or contact support." -ForegroundColor Yellow
    exit 1
}

# Import module
if (-not (Get-Module -ListAvailable -Name Microsoft.Graph)) {
    Write-Host "Installing Microsoft.Graph module..." -ForegroundColor Yellow
    Install-Module Microsoft.Graph -Scope CurrentUser -Force
}

Import-Module Microsoft.Graph.Identity.DirectoryManagement

# Connect
Write-Host "Connecting to Microsoft Graph..." -ForegroundColor Yellow
Connect-MgGraph -Scopes "Organization.ReadWrite.All", "Directory.ReadWrite.All"

# Get organization
$org = Get-MgOrganization
Write-Host "Organization: $($org.DisplayName)" -ForegroundColor Cyan

# Apply branding
try {
    Write-Host "Configuring organizational branding..." -ForegroundColor Yellow
    
    # Check if default branding exists
    $defaultBranding = $null
    try {
        $defaultBranding = Get-MgOrganizationBrandingLocalization -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "0" -ErrorAction Stop
    } catch {
        Write-Host "No default branding found, creating new..." -ForegroundColor Yellow
    }
    
    # Create or update default branding
    $brandingParams = @{
        BackgroundColor = "${primaryColorInput.value}"
        Id = "0"
    }
    
    if ($null -eq $defaultBranding) {
        # Create new branding localization
        New-MgOrganizationBrandingLocalization -OrganizationId $org.Id -BodyParameter $brandingParams
        Write-Host "Default branding created" -ForegroundColor Green
        Start-Sleep -Seconds 5
    } else {
        # Update existing
        Update-MgOrganizationBrandingLocalization -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "0" -BackgroundColor "${primaryColorInput.value}"
        Write-Host "Background color updated" -ForegroundColor Green
    }
    
    # Upload images to default localization
    Write-Host "Uploading images..." -ForegroundColor Yellow
    
    # Banner Logo
    $bannerPath = Join-Path $scriptPath "BannerLogo.png"
    Set-MgOrganizationBrandingLocalizationBannerLogo -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "0" -InFile $bannerPath
    Write-Host "  Banner logo uploaded" -ForegroundColor Green
    Start-Sleep -Seconds 2
    
    # Header Logo
    $headerPath = Join-Path $scriptPath "HeaderLogo.png"
    Set-MgOrganizationBrandingLocalizationHeaderLogo -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "0" -InFile $headerPath
    Write-Host "  Header logo uploaded" -ForegroundColor Green
    Start-Sleep -Seconds 2
    
    # Favicon
    $faviconPath = Join-Path $scriptPath "Favicon.png"
    Set-MgOrganizationBrandingLocalizationFavicon -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "0" -InFile $faviconPath
    Write-Host "  Favicon uploaded" -ForegroundColor Green
    Start-Sleep -Seconds 2
    
    # Square Logo Light
    $squarePath = Join-Path $scriptPath "SquareLogoLight.png"
    Set-MgOrganizationBrandingLocalizationSquareLogo -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "0" -InFile $squarePath
    Write-Host "  Square logo (light) uploaded" -ForegroundColor Green
    Start-Sleep -Seconds 2
    
    # Background Image Light
    $bgPath = Join-Path $scriptPath "BackgroundLight.jpg"
    Set-MgOrganizationBrandingLocalizationBackgroundImage -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "0" -InFile $bgPath
    Write-Host "  Background image (light) uploaded" -ForegroundColor Green
    
    # Try to create dark theme localization
    Write-Host "Configuring dark theme..." -ForegroundColor Yellow
    
    $darkBranding = $null
    try {
        $darkBranding = Get-MgOrganizationBrandingLocalization -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "en-US" -ErrorAction Stop
    } catch {
        Write-Host "Creating dark theme configuration..." -ForegroundColor Yellow
    }
    
    if ($null -eq $darkBranding) {
        try {
            $darkParams = @{
                BackgroundColor = "${primaryColorInput.value}"
                Id = "en-US"
            }
            New-MgOrganizationBrandingLocalization -OrganizationId $org.Id -BodyParameter $darkParams
            Start-Sleep -Seconds 5
            
            # Upload all dark theme images
            # Banner Logo for dark theme (same as light)
            Set-MgOrganizationBrandingLocalizationBannerLogo -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "en-US" -InFile $bannerPath
            Write-Host "  Dark theme banner logo uploaded" -ForegroundColor Green
            Start-Sleep -Seconds 2
            
            # Header Logo for dark theme (same as light)
            Set-MgOrganizationBrandingLocalizationHeaderLogo -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "en-US" -InFile $headerPath
            Write-Host "  Dark theme header logo uploaded" -ForegroundColor Green
            Start-Sleep -Seconds 2
            
            # Favicon for dark theme (same as light)
            Set-MgOrganizationBrandingLocalizationFavicon -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "en-US" -InFile $faviconPath
            Write-Host "  Dark theme favicon uploaded" -ForegroundColor Green
            Start-Sleep -Seconds 2
            
            # Square Logo Dark
            $squareDarkPath = Join-Path $scriptPath "SquareLogoDark.png"
            Set-MgOrganizationBrandingLocalizationSquareLogo -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "en-US" -InFile $squareDarkPath
            Write-Host "  Dark theme square logo uploaded" -ForegroundColor Green
            Start-Sleep -Seconds 2
            
            # Dark Background
            $bgDarkPath = Join-Path $scriptPath "BackgroundDark.jpg"
            Set-MgOrganizationBrandingLocalizationBackgroundImage -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "en-US" -InFile $bgDarkPath
            Write-Host "  Dark theme background uploaded" -ForegroundColor Green
        } catch {
            Write-Host "Note: Dark theme configuration may not be available" -ForegroundColor Yellow
        }
    } else {
        # Update existing dark theme branding
        Update-MgOrganizationBrandingLocalization -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "en-US" -BackgroundColor "${primaryColorInput.value}"
        
        # Upload all dark theme images
        Set-MgOrganizationBrandingLocalizationBannerLogo -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "en-US" -InFile $bannerPath
        Write-Host "  Dark theme banner logo uploaded" -ForegroundColor Green
        Start-Sleep -Seconds 2
        
        Set-MgOrganizationBrandingLocalizationHeaderLogo -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "en-US" -InFile $headerPath
        Write-Host "  Dark theme header logo uploaded" -ForegroundColor Green
        Start-Sleep -Seconds 2
        
        Set-MgOrganizationBrandingLocalizationFavicon -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "en-US" -InFile $faviconPath
        Write-Host "  Dark theme favicon uploaded" -ForegroundColor Green
        Start-Sleep -Seconds 2
        
        $squareDarkPath = Join-Path $scriptPath "SquareLogoDark.png"
        Set-MgOrganizationBrandingLocalizationSquareLogo -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "en-US" -InFile $squareDarkPath
        Write-Host "  Dark theme square logo uploaded" -ForegroundColor Green
        Start-Sleep -Seconds 2
        
        $bgDarkPath = Join-Path $scriptPath "BackgroundDark.jpg"
        Set-MgOrganizationBrandingLocalizationBackgroundImage -OrganizationId $org.Id -OrganizationalBrandingLocalizationId "en-US" -InFile $bgDarkPath
        Write-Host "  Dark theme background uploaded" -ForegroundColor Green
    }
    
    Write-Host ""
    Write-Host "Branding applied successfully!" -ForegroundColor Green
    Write-Host "Changes may take up to 24 hours to propagate." -ForegroundColor Yellow
    
} catch {
    Write-Host "Error: $_" -ForegroundColor Red
    Write-Host "If you see 'Uri is invalid' errors, try running the script again in a few minutes." -ForegroundColor Yellow
}

# Disconnect
Disconnect-MgGraph
Write-Host "Done!" -ForegroundColor Green`;
        }
        
        function updatePreview() {
            if (generatedAssets.signInBgLight) {
                const bgImage = darkMode ? generatedAssets.signInBgDark : generatedAssets.signInBgLight;
                
                previewArea.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-gray-300 mb-2 font-semibold">Logo Assets</p>
                            <div class="space-y-3">
                                <div>
                                    <p class="text-xs text-gray-400 mb-1">Banner Logo (280√ó60) - Email footers & some headers</p>
                                    <div class="rounded overflow-hidden shadow border border-gray-600 inline-block">
                                        <img src="${generatedAssets.bannerLogo}" width="280" height="60">
                                    </div>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400 mb-1">Header Logo (245√ó36) - App navigation headers</p>
                                    <div class="rounded overflow-hidden shadow border border-gray-600 inline-block">
                                        <img src="${generatedAssets.headerLogo}" width="245" height="36">
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">Square Logo Light</p>
                                        <div class="rounded overflow-hidden shadow border border-gray-600 bg-gray-50 p-2">
                                            <img src="${generatedAssets.squareLogoLight}" width="120" height="120">
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">Square Logo Dark</p>
                                        <div class="rounded overflow-hidden shadow border border-gray-600 bg-gray-900 p-2">
                                            <img src="${generatedAssets.squareLogoDark}" width="120" height="120">
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400 mb-1">Favicon (32√ó32)</p>
                                        <div class="rounded overflow-hidden shadow border border-gray-600 bg-white flex items-center justify-center" style="height: 124px;">
                                            <img src="${generatedAssets.favicon}" width="32" height="32">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <p class="text-sm text-gray-300 mb-2 font-semibold">Sign-in Page Preview</p>
                            <div class="relative rounded-lg overflow-hidden shadow-lg">
                                <img src="${bgImage}" class="w-full" style="height: 300px; object-fit: cover;">
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <div class="bg-white bg-opacity-95 p-6 rounded-lg shadow-xl" style="width: 320px;">
                                        <img src="${darkMode ? generatedAssets.squareLogoDark : generatedAssets.squareLogoLight}" class="h-14 mb-3 mx-auto">
                                        <h2 class="text-lg font-semibold text-center mb-4 text-gray-900">Sign in</h2>
                                        <input type="text" placeholder="Email" class="w-full px-3 py-2 border rounded mb-3 text-sm">
                                        <button style="background-color: ${primaryColorInput.value}" class="w-full px-3 py-2 text-white rounded text-sm">Next</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function showResults() {
            resultsSection.classList.remove('hidden');
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Download ZIP
        downloadBtn.addEventListener('click', () => {
            const zip = new JSZip();
            
            function dataURLtoBlob(dataURL) {
                const parts = dataURL.split(',');
                const mime = parts[0].match(/:(.*?);/)[1];
                const bstr = atob(parts[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while(n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new Blob([u8arr], {type: mime});
            }
            
            // Add images
            zip.file('BannerLogo.png', dataURLtoBlob(generatedAssets.bannerLogo));
            zip.file('HeaderLogo.png', dataURLtoBlob(generatedAssets.headerLogo));
            zip.file('Favicon.png', dataURLtoBlob(generatedAssets.favicon));
            zip.file('SquareLogoLight.png', dataURLtoBlob(generatedAssets.squareLogoLight));
            zip.file('SquareLogoDark.png', dataURLtoBlob(generatedAssets.squareLogoDark));
            zip.file('BackgroundLight.jpg', dataURLtoBlob(generatedAssets.signInBgLight));
            zip.file('BackgroundDark.jpg', dataURLtoBlob(generatedAssets.signInBgDark));
            
            // Add script only (no readme)
            zip.file('Deploy-M365Branding.ps1', generatedAssets.script);
            
            // Generate ZIP
            zip.generateAsync({type: 'blob'}).then(function(content) {
                saveAs(content, 'M365_Branding_Package.zip');
            });
        });
    </script>
</body>
</html>
